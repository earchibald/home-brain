name: Escalate CI Failure to Copilot

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  escalate:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}

    steps:
      - uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-results-3.12
          path: test-results/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Read test output
        id: test-output
        run: |
          if [ -f test-results/output.txt ]; then
            # Get last 100 lines of test output (failures + summary)
            OUTPUT=$(tail -100 test-results/output.txt)
          else
            OUTPUT="Test artifacts not available. Check the CI run manually."
          fi
          # Store in file to avoid delimiter issues
          echo "$OUTPUT" > /tmp/test-output.txt

      - name: Get failure context
        id: context
        run: |
          echo "run_url=${{ github.event.workflow_run.html_url }}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"

      - name: Create issue for Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testOutput = fs.readFileSync('/tmp/test-output.txt', 'utf8');
            const runUrl = '${{ steps.context.outputs.run_url }}';
            const commitSha = '${{ steps.context.outputs.commit_sha }}';
            const branch = '${{ steps.context.outputs.branch }}';

            const body = `## CI Failure - Auto-escalated

            **Branch:** \`${branch}\`
            **Commit:** \`${commitSha}\`
            **CI Run:** ${runUrl}

            ### Test Output
            \`\`\`
            ${testOutput.substring(0, 60000)}
            \`\`\`

            ### Instructions for Copilot
            1. Check out the failing commit
            2. Reproduce the test failures locally with \`python -m pytest tests/ -m "unit or integration" -v\`
            3. Analyze the test output above to identify root cause
            4. Fix the failing tests - do NOT skip or delete tests
            5. Ensure all existing tests still pass
            6. Create a PR with the fix

            ### Project Context
            - Python 3.12 project
            - Tests use pytest with asyncio support
            - Key directories: \`agents/\`, \`clients/\`, \`slack_bot/\`, \`tests/\`
            - See \`CLAUDE.md\` and \`.github/copilot-instructions.md\` for project details
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure: Tests failing on ${branch} (${commitSha.substring(0, 7)})`,
              body: body,
              labels: ['bug'],
              assignees: ['copilot']
            });

            core.setOutput('issue_url', issue.data.html_url);
            core.setOutput('issue_number', issue.data.number);

      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"ðŸ”´ CI Failed on main â€” issue created and assigned to Copilot\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*CI Failure on \`${{ steps.context.outputs.branch }}\`*\n\nCommit: \`${{ steps.context.outputs.commit_sha }}\`\nCI Run: ${{ steps.context.outputs.run_url }}\n\nA GitHub issue has been created and assigned to Copilot for auto-fix.\"
                    }
                  }
                ]
              }"
          fi
