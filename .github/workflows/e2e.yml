name: E2E Tests

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      notify_slack:
        description: 'Post results to Slack'
        required: false
        default: 'true'
        type: boolean

  # Weekly schedule: Mondays at 12:00 UTC (noon)
  schedule:
    - cron: '0 12 * * 1'

permissions:
  contents: read

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements-test.txt
          pip install slack-sdk

      - name: Run E2E tests
        id: e2e_tests
        env:
          SLACK_TEST_BOT_TOKEN: ${{ secrets.SLACK_TEST_BOT_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          BRAIN_BOT_USER_ID: ${{ secrets.BRAIN_BOT_USER_ID }}
          TEST_BOT_USER_ID: ${{ secrets.TEST_BOT_USER_ID }}
        run: |
          set -o pipefail
          mkdir -p test-results
          
          # Run E2E tests with detailed output
          python -m pytest tests/e2e/ -m e2e \
            --tb=short \
            --junitxml=test-results/e2e-results.xml \
            -v 2>&1 | tee test-results/e2e-output.txt
          
          # Capture exit code
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 30

      - name: Notify Slack on success
        if: success() && (github.event.inputs.notify_slack == 'true' || github.event_name == 'schedule')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"âœ… E2E Tests Passed\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*âœ… E2E Tests Passed*\n\nBrain Assistant bot is responding correctly to test messages.\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run> â€¢ Triggered by: ${{ github.event_name }}\"
                      }
                    ]
                  }
                ]
              }"
          fi

      - name: Notify Slack on failure
        if: failure() && (github.event.inputs.notify_slack == 'true' || github.event_name == 'schedule')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            # Extract failure details from test output
            FAILURE_DETAILS=$(tail -20 test-results/e2e-output.txt 2>/dev/null || echo "See full logs for details")
            
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"ðŸ”´ E2E Tests Failed\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ðŸ”´ E2E Tests Failed*\n\nBrain Assistant bot may be down or not responding correctly.\"
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"\`\`\`\n${FAILURE_DETAILS}\n\`\`\`\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Logs> â€¢ Triggered by: ${{ github.event_name }}\"
                      }
                    ]
                  }
                ]
              }"
          fi
